{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
{{ form.media }}
<style>
    .notification-panel {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        align-items: start;
    }
    @media (max-width: 900px) {
        .notification-panel { grid-template-columns: 1fr; }
    }
    .phone-preview { position: sticky; top: 80px; }
    .phone-frame {
        background: #1a1a2e;
        border-radius: 30px;
        padding: 15px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 360px;
        margin: 0 auto;
    }
    .phone-screen {
        background: #16213e;
        border-radius: 20px;
        overflow: hidden;
        padding: 20px 15px;
        min-height: 200px;
    }
    .phone-statusbar {
        display: flex;
        justify-content: space-between;
        color: #fff;
        font-size: 11px;
        padding: 5px 5px 15px;
        opacity: 0.7;
    }
    .notif-card {
        background: rgba(255,255,255,0.95);
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .notif-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .notif-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
    }
    .notif-app-name { font-size: 12px; color: #666; font-weight: 600; }
    .notif-time { font-size: 11px; color: #999; margin-left: auto; }
    .notif-title { font-weight: 700; font-size: 14px; color: #111; margin-bottom: 4px; word-break: break-word; }
    .notif-body { font-size: 13px; color: #444; line-height: 1.4; word-break: break-word; }
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #F2994A 0%, #F2C94C 100%); }
    .stat-card.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
    .stat-number { font-size: 28px; font-weight: 700; display: block; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; }
    .emoji-bar { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
    .emoji-btn {
        font-size: 20px; cursor: pointer; border: 2px solid transparent;
        border-radius: 8px; padding: 4px 8px; background: #f0f0f0; transition: all 0.2s;
    }
    .emoji-btn:hover { border-color: #667eea; transform: scale(1.15); background: #e0e0ff; }
    .template-btn {
        display: inline-block; padding: 6px 14px; margin: 4px;
        border: 1px solid #ccc; border-radius: 20px; font-size: 12px;
        cursor: pointer; background: #fff; transition: all 0.2s;
    }
    .template-btn:hover { background: #667eea; color: white; border-color: #667eea; }
    .destinatarios-info {
        background: #fff3cd; border: 1px solid #ffeaa7;
        padding: 12px 15px; border-radius: 8px; margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-main">
    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-number">{{ total_participantes }}</span>
            <span class="stat-label">Total Participantes</span>
        </div>
        <div class="stat-card green">
            <span class="stat-number">{{ com_notifs_ativadas }}</span>
            <span class="stat-label">Notifs Ativadas</span>
        </div>
        <div class="stat-card orange">
            <span class="stat-number">{{ com_push_subscription }}</span>
            <span class="stat-label">Com Push</span>
        </div>
        <div class="stat-card red">
            <span class="stat-number">{{ notifs_enviadas_hoje }}</span>
            <span class="stat-label">Enviadas Hoje</span>
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        
        <div class="notification-panel">
            <!-- Coluna esquerda: formul√°rio -->
            <div>
                <h1>{{ title }}</h1>
                
                {% if subtitle %}
                <p style="font-size: 15px; color: #666; margin-bottom: 20px;">{{ subtitle }}</p>
                {% endif %}
                
                {% if participantes_count > 0 %}
                <div class="destinatarios-info">
                    <strong>üìã Participantes pr√©-selecionados:</strong> {{ participantes_count }}
                </div>
                {% endif %}
                
                {% if form.errors %}
                <div style="background: #ffe0e0; border: 1px solid #e74c3c; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è Corrija os erros abaixo:</strong>
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <!-- Templates r√°pidos -->
                <fieldset class="module">
                    <h2>‚ö° Templates R√°pidos</h2>
                    <div style="padding: 10px;">
                        <div class="template-btn" onclick="applyTemplate('rodada')">üÜï Nova Rodada</div>
                        <div class="template-btn" onclick="applyTemplate('lembrete')">‚è∞ Lembrete Prazo</div>
                        <div class="template-btn" onclick="applyTemplate('resultados')">üìä Resultados</div>
                        <div class="template-btn" onclick="applyTemplate('ranking')">üèÜ Ranking</div>
                        <div class="template-btn" onclick="applyTemplate('anuncio')">üì¢ An√∫ncio Geral</div>
                        <div class="template-btn" onclick="applyTemplate('manutencao')">üîß Manuten√ß√£o</div>
                    </div>
                </fieldset>

                <fieldset class="module aligned">
                    <h2>üìù Conte√∫do da Notifica√ß√£o</h2>
                    
                    <div class="form-row">
                        <div>
                            <label for="{{ form.tipo.id_for_label }}" class="required">Tipo:</label>
                            {{ form.tipo }}
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="{{ form.titulo.id_for_label }}" class="required">T√≠tulo:</label>
                            {{ form.titulo }}
                            <p class="help">M√°x 100 caracteres. <strong id="titulo-count">0</strong>/100</p>
                            {% for error in form.titulo.errors %}<ul class="errorlist"><li>{{ error }}</li></ul>{% endfor %}
                        </div>
                    </div>

                    <!-- Emojis r√°pidos -->
                    <div class="form-row">
                        <div>
                            <label>Emojis r√°pidos:</label>
                            <div class="emoji-bar">
                                <span class="emoji-btn" onclick="insertEmoji('‚öΩ')">‚öΩ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üèÜ')">üèÜ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üéØ')">üéØ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üî•')">üî•</span>
                                <span class="emoji-btn" onclick="insertEmoji('üéâ')">üéâ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üìä')">üìä</span>
                                <span class="emoji-btn" onclick="insertEmoji('‚è∞')">‚è∞</span>
                                <span class="emoji-btn" onclick="insertEmoji('üöÄ')">üöÄ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üì¢')">üì¢</span>
                                <span class="emoji-btn" onclick="insertEmoji('üí™')">üí™</span>
                                <span class="emoji-btn" onclick="insertEmoji('‚≠ê')">‚≠ê</span>
                                <span class="emoji-btn" onclick="insertEmoji('ü•á')">ü•á</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="{{ form.mensagem.id_for_label }}" class="required">Mensagem:</label>
                            {{ form.mensagem }}
                            {% for error in form.mensagem.errors %}<ul class="errorlist"><li>{{ error }}</li></ul>{% endfor %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="{{ form.url_acao.id_for_label }}">URL de A√ß√£o:</label>
                            {{ form.url_acao }}
                            <p class="help">{{ form.url_acao.help_text }}</p>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="module aligned">
                    <h2>üéØ Destinat√°rios</h2>
                    
                    <div class="form-row">
                        <div>
                            <label for="{{ form.destinatarios.id_for_label }}" class="required">Para quem enviar:</label>
                            {{ form.destinatarios }}
                            <p class="help" id="destinatarios-desc"></p>
                        </div>
                    </div>

                    <div class="form-row" id="participantes_especificos" style="display: none;">
                        <div>
                            <label for="{{ form.participantes_selecionados.id_for_label }}">Participantes:</label>
                            {{ form.participantes_selecionados }}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="module aligned">
                    <h2>‚öôÔ∏è Op√ß√µes</h2>
                    
                    <div class="form-row">
                        <div>
                            <label for="{{ form.rodada_relacionada.id_for_label }}">Rodada Relacionada:</label>
                            {{ form.rodada_relacionada }}
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            {{ form.enviar_imediatamente }}
                            <label for="{{ form.enviar_imediatamente.id_for_label }}" style="display: inline;">
                                {{ form.enviar_imediatamente.label }}
                            </label>
                            <p class="help">{{ form.enviar_imediatamente.help_text }}</p>
                        </div>
                    </div>
                </fieldset>

                <div class="submit-row">
                    <input type="submit" value="üöÄ Enviar Notifica√ß√£o" class="default" style="font-size: 15px; padding: 10px 30px;" />
                    <a href="/admin/bolao/notification/" style="padding: 10px 20px; margin-left: 10px;">Cancelar</a>
                </div>
            </div>

            <!-- Coluna direita: preview estilo celular -->
            <div class="phone-preview">
                <h3 style="text-align: center; color: #666; margin-bottom: 10px;">üì± Preview da Notifica√ß√£o</h3>
                <div class="phone-frame">
                    <div class="phone-screen">
                        <div class="phone-statusbar">
                            <span>9:41</span>
                            <span>FutAmigo</span>
                            <span>üì∂ üîã</span>
                        </div>
                        
                        <div class="notif-card" id="notif-preview">
                            <div class="notif-header">
                                <img src="{% static 'futfavi.webp' %}" alt="FutAmigo" class="notif-icon">
                                <div>
                                    <div class="notif-app-name">FutAmigo</div>
                                </div>
                                <div class="notif-time">agora</div>
                            </div>
                            <div class="notif-title" id="preview-title">‚öΩ T√≠tulo da notifica√ß√£o</div>
                            <div class="notif-body" id="preview-body">Mensagem da notifica√ß√£o aparecer√° aqui...</div>
                        </div>

                        <div style="text-align: center; margin-top: 30px; opacity: 0.4;">
                            <img src="{% static 'futfavi.webp' %}" alt="" style="width: 50px; border-radius: 12px;">
                            <p style="color: #fff; font-size: 11px; margin-top: 8px;">√çcone usado nas notifica√ß√µes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tituloInput = document.getElementById('{{ form.titulo.id_for_label }}');
    const mensagemInput = document.getElementById('{{ form.mensagem.id_for_label }}');
    const previewTitle = document.getElementById('preview-title');
    const previewBody = document.getElementById('preview-body');
    const tituloCount = document.getElementById('titulo-count');
    const destinatariosSelect = document.getElementById('{{ form.destinatarios.id_for_label }}');
    const participantesDiv = document.getElementById('participantes_especificos');
    const destinatariosDesc = document.getElementById('destinatarios-desc');

    const descMap = {
        'todos': 'üì£ Envia para TODOS os {{ total_participantes }} participantes',
        'ativos': '‚úÖ Apenas participantes ativos',
        'com_notifs': 'üîî {{ com_notifs_ativadas }} participantes com notifica√ß√µes ativadas',
        'selecionados': 'üë• Escolha participantes espec√≠ficos abaixo'
    };

    function updatePreview() {
        previewTitle.textContent = tituloInput.value || '‚öΩ T√≠tulo da notifica√ß√£o';
        previewBody.textContent = mensagemInput.value || 'Mensagem da notifica√ß√£o aparecer√° aqui...';
        tituloCount.textContent = tituloInput.value.length;
        tituloCount.style.color = tituloInput.value.length > 80 ? '#e74c3c' : '#333';
    }

    tituloInput.addEventListener('input', updatePreview);
    mensagemInput.addEventListener('input', updatePreview);

    function toggleParticipantes() {
        participantesDiv.style.display = destinatariosSelect.value === 'selecionados' ? 'block' : 'none';
        destinatariosDesc.textContent = descMap[destinatariosSelect.value] || '';
    }

    destinatariosSelect.addEventListener('change', toggleParticipantes);
    toggleParticipantes();
    updatePreview();
});

// Inserir emoji
let lastFocusedInput = null;
document.getElementById('{{ form.titulo.id_for_label }}').addEventListener('focus', function() { lastFocusedInput = this; });
document.getElementById('{{ form.mensagem.id_for_label }}').addEventListener('focus', function() { lastFocusedInput = this; });

function insertEmoji(emoji) {
    const input = lastFocusedInput || document.getElementById('{{ form.titulo.id_for_label }}');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
    input.selectionStart = input.selectionEnd = start + emoji.length;
    input.focus();
    input.dispatchEvent(new Event('input'));
}

// Templates r√°pidos
function applyTemplate(tipo) {
    const tituloInput = document.getElementById('{{ form.titulo.id_for_label }}');
    const mensagemInput = document.getElementById('{{ form.mensagem.id_for_label }}');
    const tipoSelect = document.getElementById('{{ form.tipo.id_for_label }}');

    const templates = {
        'rodada': { tipo: 'nova_rodada', titulo: 'üÜï Nova Rodada Dispon√≠vel!', mensagem: '‚öΩ Uma nova rodada est√° aberta para palpites! Entre agora e fa√ßa seus palpites antes que o prazo termine. Boa sorte! üçÄ' },
        'lembrete': { tipo: 'lembrete_prazo', titulo: '‚è∞ √öltimo prazo para palpites!', mensagem: 'üö® Faltam poucas horas para o prazo encerrar! N√£o fique de fora, garanta seus pontos! üí™' },
        'resultados': { tipo: 'resultados', titulo: 'üìä Resultados da Rodada!', mensagem: 'üèÜ Os resultados foram publicados! Confira como foi sua rodada e veja a classifica√ß√£o atualizada. üìà' },
        'ranking': { tipo: 'ranking', titulo: 'üèÜ Ranking Atualizado!', mensagem: 'üìà A classifica√ß√£o geral foi atualizada! Confira sua posi√ß√£o e veja quem subiu ou desceu. üî•' },
        'anuncio': { tipo: 'sistema', titulo: 'üì¢ Novidade no FutAmigo!', mensagem: 'üöÄ Temos novidades para voc√™! Acesse o FutAmigo e confira as atualiza√ß√µes. ‚öΩ' },
        'manutencao': { tipo: 'sistema', titulo: 'üîß Manuten√ß√£o Programada', mensagem: '‚ö†Ô∏è O FutAmigo passar√° por uma breve manuten√ß√£o para melhorias. Voltaremos em breve! üôè' }
    };

    const t = templates[tipo];
    if (t) {
        tituloInput.value = t.titulo;
        mensagemInput.value = t.mensagem;
        tipoSelect.value = t.tipo;
        tituloInput.dispatchEvent(new Event('input'));
        mensagemInput.dispatchEvent(new Event('input'));
    }
}
</script>
{% endblock %}
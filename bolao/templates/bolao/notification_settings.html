{% extends 'bolao/base.html' %}

{% block title %}Configura√ß√µes de Notifica√ß√µes - FutAmigo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bell me-2"></i>
                Notifica√ß√µes
            </h1>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar
            </a>
        </div>

        <!-- Status das Notifica√ß√µes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Status das Notifica√ß√µes
                        </h5>
                        <span id="notificationStatus" class="badge bg-secondary">Verificando...</span>
                    </div>
                    <div class="card-body">
                        <div id="permissionAlert" class="alert alert-warning d-none">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Permiss√£o necess√°ria:</strong>
                            Para receber notifica√ß√µes, voc√™ precisa permitir no seu navegador.
                            <button id="enableNotifications" class="btn btn-warning btn-sm ms-2">
                                <i class="fas fa-bell me-1"></i>
                                Ativar Agora
                            </button>
                        </div>
                        
                        <div id="supportedAlert" class="alert alert-success d-none">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Notifica√ß√µes ativadas!</strong>
                            Voc√™ receber√° alertas importantes sobre o bol√£o.
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button id="testNotification" class="btn btn-primary" disabled>
                                <i class="fas fa-paper-plane me-1"></i>
                                Testar Notifica√ß√£o
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configura√ß√µes -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>
                            Configura√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="notificationForm" method="post">
                            {% csrf_token %}
                            
                            <!-- Ativar/Desativar Geral -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if settings.enabled %}checked{% endif %}>
                                    <label class="form-check-label fw-bold" for="enabled">
                                        <i class="fas fa-bell me-2"></i>
                                        Ativar Notifica√ß√µes
                                    </label>
                                </div>
                                <small class="text-muted">Liga/desliga todas as notifica√ß√µes</small>
                            </div>

                            <hr>

                            <!-- Tipos de Notifica√ß√£o -->
                            <div id="notificationTypes" {% if not settings.enabled %}class="opacity-50"{% endif %}>
                                <h6 class="mb-3">Tipos de Notifica√ß√£o:</h6>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="nova_rodada" name="nova_rodada" {% if settings.nova_rodada %}checked{% endif %}>
                                            <label class="form-check-label" for="nova_rodada">
                                                <i class="fas fa-calendar-plus text-success me-2"></i>
                                                <strong>Nova Rodada</strong><br>
                                                <small class="text-muted">Quando uma nova rodada for liberada para palpites</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="lembrete_prazo" name="lembrete_prazo" {% if settings.lembrete_prazo %}checked{% endif %}>
                                            <label class="form-check-label" for="lembrete_prazo">
                                                <i class="fas fa-clock text-warning me-2"></i>
                                                <strong>Lembrete de Prazo</strong><br>
                                                <small class="text-muted">2 horas antes do fim dos palpites</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="resultados_publicados" name="resultados_publicados" {% if settings.resultados_publicados %}checked{% endif %}>
                                            <label class="form-check-label" for="resultados_publicados">
                                                <i class="fas fa-trophy text-primary me-2"></i>
                                                <strong>Resultados</strong><br>
                                                <small class="text-muted">Quando os resultados forem publicados</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="ranking_atualizado" name="ranking_atualizado" {% if settings.ranking_atualizado %}checked{% endif %}>
                                            <label class="form-check-label" for="ranking_atualizado">
                                                <i class="fas fa-chart-line text-info me-2"></i>
                                                <strong>Ranking</strong><br>
                                                <small class="text-muted">Quando sua posi√ß√£o no ranking mudar</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>
                                    Salvar Configura√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            √öltimas Notifica√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if historico %}
                            {% for notif in historico %}
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom">
                                <div class="flex-grow-1">
                                    <small class="text-muted">{{ notif.get_tipo_display }}</small>
                                    <div class="fw-bold">{{ notif.titulo }}</div>
                                    <small class="text-muted">{{ notif.criada_em|date:"d/m H:i" }}</small>
                                </div>
                                <span class="badge bg-{% if notif.status == 'sent' %}success{% elif notif.status == 'failed' %}danger{% else %}secondary{% endif %} ms-2">
                                    {{ notif.get_status_display }}
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>Nenhuma notifica√ß√£o enviada ainda</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vari√°veis globais
let notificationPermission = 'default';
let serviceWorkerRegistration = null;

// Elementos
const notificationStatus = document.getElementById('notificationStatus');
const permissionAlert = document.getElementById('permissionAlert');
const supportedAlert = document.getElementById('supportedAlert');
const enableButton = document.getElementById('enableNotifications');
const testButton = document.getElementById('testNotification');
const notificationForm = document.getElementById('notificationForm');
const enabledSwitch = document.getElementById('enabled');
const notificationTypes = document.getElementById('notificationTypes');

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    checkNotificationSupport();
    setupEventListeners();
});

// Verificar suporte a notifica√ß√µes
function checkNotificationSupport() {
    if (!('Notification' in window)) {
        notificationStatus.textContent = 'N√£o Suportado';
        notificationStatus.className = 'badge bg-danger';
        return;
    }
    
    notificationPermission = Notification.permission;
    updateNotificationStatus();
    
    // Verificar service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            serviceWorkerRegistration = registration;
        });
    }
}

// Atualizar status visual
function updateNotificationStatus() {
    switch (notificationPermission) {
        case 'granted':
            notificationStatus.textContent = 'Ativadas';
            notificationStatus.className = 'badge bg-success';
            permissionAlert.classList.add('d-none');
            supportedAlert.classList.remove('d-none');
            testButton.disabled = false;
            break;
        case 'denied':
            notificationStatus.textContent = 'Bloqueadas';
            notificationStatus.className = 'badge bg-danger';
            permissionAlert.classList.add('d-none');
            supportedAlert.classList.add('d-none');
            testButton.disabled = true;
            break;
        default:
            notificationStatus.textContent = 'N√£o Permitidas';
            notificationStatus.className = 'badge bg-warning';
            permissionAlert.classList.remove('d-none');
            supportedAlert.classList.add('d-none');
            testButton.disabled = true;
            break;
    }
}

// Event listeners
function setupEventListeners() {
    // Bot√£o ativar notifica√ß√µes
    enableButton.addEventListener('click', requestNotificationPermission);
    
    // Bot√£o testar notifica√ß√£o
    testButton.addEventListener('click', testNotification);
    
    // Switch principal
    enabledSwitch.addEventListener('change', function() {
        notificationTypes.style.opacity = this.checked ? '1' : '0.5';
    });
    
    // Formul√°rio
    notificationForm.addEventListener('submit', saveSettings);
}

// Solicitar permiss√£o
async function requestNotificationPermission() {
    try {
        enableButton.disabled = true;
        enableButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Solicitando...';
        
        const permission = await Notification.requestPermission();
        notificationPermission = permission;
        updateNotificationStatus();
        
        if (permission === 'granted') {
            // Salvar subscription para push notifications
            await savePushSubscription();
            showToast('Notifica√ß√µes ativadas com sucesso! üéâ', 'success');
        } else {
            showToast('Permiss√£o negada. Voc√™ pode ativar depois nas configura√ß√µes do navegador.', 'warning');
        }
    } catch (error) {
        console.error('Erro ao solicitar permiss√£o:', error);
        showToast('Erro ao solicitar permiss√£o para notifica√ß√µes', 'danger');
    } finally {
        enableButton.disabled = false;
        enableButton.innerHTML = '<i class="fas fa-bell me-1"></i>Ativar Agora';
    }
}

// Salvar push subscription
async function savePushSubscription() {
    if (!serviceWorkerRegistration) return;
    
    try {
        const subscription = await serviceWorkerRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: null // Aqui iria a chave VAPID futuramente
        });
        
        const response = await fetch('{% url "save_push_subscription" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(subscription)
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('Push subscription salva com sucesso');
        }
    } catch (error) {
        console.error('Erro ao salvar push subscription:', error);
    }
}

// Testar notifica√ß√£o
async function testNotification() {
    try {
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
        
        const response = await fetch('{% url "test_notification" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mostrar notifica√ß√£o local tamb√©m
            if (notificationPermission === 'granted') {
                new Notification('üéâ Teste de Notifica√ß√£o', {
                    body: 'Se voc√™ est√° vendo isso, as notifica√ß√µes est√£o funcionando perfeitamente!',
                    icon: '/static/icons/icon-192x192.png',
                    tag: 'test-notification'
                });
            }
            showToast('Notifica√ß√£o de teste enviada! üì±', 'success');
        } else {
            showToast('Erro ao enviar notifica√ß√£o: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Erro ao testar notifica√ß√£o:', error);
        showToast('Erro ao enviar notifica√ß√£o de teste', 'danger');
    } finally {
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Testar Notifica√ß√£o';
    }
}

// Salvar configura√ß√µes
async function saveSettings(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(notificationForm);
        
        const response = await fetch('{% url "notification_settings" %}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Configura√ß√µes salvas com sucesso! ‚úÖ', 'success');
        } else {
            showToast('Erro ao salvar configura√ß√µes', 'danger');
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar configura√ß√µes', 'danger');
    }
}

// Fun√ß√£o para mostrar toasts (reutilizada do palpites.html)
function showToast(message, type = 'info') {
    const toastHTML = `
        <div class="toast align-items-center text-bg-${type} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.body.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remover elemento ap√≥s esconder
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}
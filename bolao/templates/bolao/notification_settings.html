{% extends 'bolao/base.html' %}

{% block title %}Configura√ß√µes de Notifica√ß√µes - FutAmigo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bell me-2"></i>
                Notifica√ß√µes
            </h1>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar
            </a>
        </div>

        <!-- Status das Notifica√ß√µes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Status das Notifica√ß√µes
                        </h5>
                        <span id="notificationStatus" class="badge bg-secondary">Verificando...</span>
                    </div>
                    <div class="card-body">
                        <div id="permissionAlert" class="alert alert-warning d-none">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Permiss√£o necess√°ria:</strong>
                            Para receber notifica√ß√µes, voc√™ precisa permitir no seu navegador.
                            <button id="enableNotifications" class="btn btn-warning btn-sm ms-2">
                                <i class="fas fa-bell me-1"></i>
                                Ativar Agora
                            </button>
                        </div>
                        
                        <div id="supportedAlert" class="alert alert-success d-none">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Notifica√ß√µes ativadas!</strong>
                            Voc√™ receber√° alertas importantes sobre o bol√£o.
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button id="testNotification" class="btn btn-primary" disabled>
                                <i class="fas fa-paper-plane me-1"></i>
                                Testar Notifica√ß√£o
                            </button>
                            <button id="debugInfo" class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#debugPanel">
                                <i class="fas fa-bug me-1"></i>
                                Debug
                            </button>
                        </div>
                        
                        <!-- Painel de Debug -->
                        <div class="collapse mt-3" id="debugPanel">
                            <div class="card card-body bg-light">
                                <h6><i class="fas fa-microscope me-2"></i>Informa√ß√µes T√©cnicas</h6>
                                <small id="debugContent" class="text-muted">Carregando informa√ß√µes...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configura√ß√µes -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>
                            Configura√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="notificationForm" method="post">
                            {% csrf_token %}
                            
                            <!-- Ativar/Desativar Geral -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if settings.enabled %}checked{% endif %}>
                                    <label class="form-check-label fw-bold" for="enabled">
                                        <i class="fas fa-bell me-2"></i>
                                        Ativar Notifica√ß√µes
                                    </label>
                                </div>
                                <small class="text-muted">Liga/desliga todas as notifica√ß√µes</small>
                            </div>

                            <hr>

                            <!-- Tipos de Notifica√ß√£o -->
                            <div id="notificationTypes" {% if not settings.enabled %}class="opacity-50"{% endif %}>
                                <h6 class="mb-3">Tipos de Notifica√ß√£o:</h6>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="nova_rodada" name="nova_rodada" {% if settings.nova_rodada %}checked{% endif %}>
                                            <label class="form-check-label" for="nova_rodada">
                                                <i class="fas fa-calendar-plus text-success me-2"></i>
                                                <strong>Nova Rodada</strong><br>
                                                <small class="text-muted">Quando uma nova rodada for liberada para palpites</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="lembrete_prazo" name="lembrete_prazo" {% if settings.lembrete_prazo %}checked{% endif %}>
                                            <label class="form-check-label" for="lembrete_prazo">
                                                <i class="fas fa-clock text-warning me-2"></i>
                                                <strong>Lembrete de Prazo</strong><br>
                                                <small class="text-muted">2 horas antes do fim dos palpites</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="resultados_publicados" name="resultados_publicados" {% if settings.resultados_publicados %}checked{% endif %}>
                                            <label class="form-check-label" for="resultados_publicados">
                                                <i class="fas fa-trophy text-primary me-2"></i>
                                                <strong>Resultados</strong><br>
                                                <small class="text-muted">Quando os resultados forem publicados</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="ranking_atualizado" name="ranking_atualizado" {% if settings.ranking_atualizado %}checked{% endif %}>
                                            <label class="form-check-label" for="ranking_atualizado">
                                                <i class="fas fa-chart-line text-info me-2"></i>
                                                <strong>Ranking</strong><br>
                                                <small class="text-muted">Quando sua posi√ß√£o no ranking mudar</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>
                                    Salvar Configura√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            √öltimas Notifica√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if historico %}
                            {% for notif in historico %}
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom">
                                <div class="flex-grow-1">
                                    <small class="text-muted">{{ notif.get_tipo_display }}</small>
                                    <div class="fw-bold">{{ notif.titulo }}</div>
                                    <small class="text-muted">{{ notif.criada_em|date:"d/m H:i" }}</small>
                                </div>
                                <span class="badge bg-{% if notif.status == 'sent' %}success{% elif notif.status == 'failed' %}danger{% else %}secondary{% endif %} ms-2">
                                    {{ notif.get_status_display }}
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>Nenhuma notifica√ß√£o enviada ainda</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vari√°veis globais
let notificationPermission = 'default';
let serviceWorkerRegistration = null;

// Elementos
const notificationStatus = document.getElementById('notificationStatus');
const permissionAlert = document.getElementById('permissionAlert');
const supportedAlert = document.getElementById('supportedAlert');
const enableButton = document.getElementById('enableNotifications');
const testButton = document.getElementById('testNotification');
const notificationForm = document.getElementById('notificationForm');
const enabledSwitch = document.getElementById('enabled');
const notificationTypes = document.getElementById('notificationTypes');

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    checkNotificationSupport();
    setupEventListeners();
    updateDebugInfo();
});

// Atualizar informa√ß√µes de debug
function updateDebugInfo() {
    const debugContent = document.getElementById('debugContent');
    
    if (!debugContent) return;
    
    const info = {
        'User Agent': navigator.userAgent,
        'Mobile': /Mobi|Android/i.test(navigator.userAgent) ? 'Sim' : 'N√£o',
        'HTTPS': window.location.protocol === 'https:' ? 'Sim' : 'N√£o',
        'Contexto Seguro': window.isSecureContext ? 'Sim' : 'N√£o',
        'Notification API': 'Notification' in window ? 'Suportada' : 'N√£o suportada',
        'Service Worker': 'serviceWorker' in navigator ? 'Suportado' : 'N√£o suportado',
        'Push Manager': 'PushManager' in window ? 'Suportado' : 'N√£o suportado',
        'Permiss√£o Atual': Notification.permission || 'undefined',
        'URL Atual': window.location.href,
        'Tela': `${screen.width}x${screen.height}`,
        'Viewport': `${window.innerWidth}x${window.innerHeight}`
    };
    
    let html = '<div class="row">';
    
    Object.entries(info).forEach(([key, value]) => {
        const isError = (key.includes('HTTPS') && value === 'N√£o') || 
                       (key.includes('Contexto') && value === 'N√£o') ||
                       (key.includes('API') && value.includes('N√£o')) ||
                       (key.includes('Permiss√£o') && value === 'denied');
        
        const textClass = isError ? 'text-danger' : 'text-success';
        
        html += `
            <div class="col-md-6 mb-1">
                <strong>${key}:</strong> 
                <span class="${textClass}">${value}</span>
            </div>
        `;
    });
    
    html += '</div>';
    
    debugContent.innerHTML = html;
}

// Verificar suporte a notifica√ß√µes
function checkNotificationSupport() {
    // Log para debug no mobile
    console.log('üîß Verificando suporte a notifica√ß√µes...');
    console.log('üîß User Agent:', navigator.userAgent);
    console.log('üîß HTTPS:', window.location.protocol === 'https:');
    
    if (!('Notification' in window)) {
        console.log('‚ùå Notification API n√£o suportada');
        notificationStatus.textContent = 'N√£o Suportado';
        notificationStatus.className = 'badge bg-danger';
        return;
    }
    
    console.log('‚úÖ Notification API suportada');
    notificationPermission = Notification.permission;
    console.log('üîß Permiss√£o atual:', notificationPermission);
    
    updateNotificationStatus();
    
    // Verificar service worker com debug melhor
    if ('serviceWorker' in navigator) {
        console.log('üîß Service Worker API dispon√≠vel');
        navigator.serviceWorker.ready
            .then(registration => {
                console.log('‚úÖ Service Worker registrado:', registration);
                serviceWorkerRegistration = registration;
            })
            .catch(error => {
                console.error('‚ùå Erro no Service Worker:', error);
            });
    } else {
        console.log('‚ùå Service Worker n√£o suportado');
    }
    
    // Verificar se estamos em contexto seguro
    if (!window.isSecureContext) {
        console.warn('‚ö†Ô∏è Contexto n√£o seguro - notifica√ß√µes podem n√£o funcionar');
        showToast('‚ö†Ô∏è Para notifica√ß√µes funcionarem corretamente, acesse via HTTPS', 'warning');
    }
}

// Atualizar status visual
function updateNotificationStatus() {
    switch (notificationPermission) {
        case 'granted':
            notificationStatus.textContent = 'Ativadas';
            notificationStatus.className = 'badge bg-success';
            permissionAlert.classList.add('d-none');
            supportedAlert.classList.remove('d-none');
            testButton.disabled = false;
            break;
        case 'denied':
            notificationStatus.textContent = 'Bloqueadas';
            notificationStatus.className = 'badge bg-danger';
            permissionAlert.classList.add('d-none');
            supportedAlert.classList.add('d-none');
            testButton.disabled = true;
            break;
        default:
            notificationStatus.textContent = 'N√£o Permitidas';
            notificationStatus.className = 'badge bg-warning';
            permissionAlert.classList.remove('d-none');
            supportedAlert.classList.add('d-none');
            testButton.disabled = true;
            break;
    }
}

// Event listeners
function setupEventListeners() {
    // Bot√£o ativar notifica√ß√µes
    enableButton.addEventListener('click', requestNotificationPermission);
    
    // Bot√£o testar notifica√ß√£o
    testButton.addEventListener('click', testNotification);
    
    // Switch principal
    enabledSwitch.addEventListener('change', function() {
        notificationTypes.style.opacity = this.checked ? '1' : '0.5';
    });
    
    // Formul√°rio
    notificationForm.addEventListener('submit', saveSettings);
}

// Solicitar permiss√£o
async function requestNotificationPermission() {
    try {
        console.log('üì± Solicitando permiss√£o para notifica√ß√µes...');
        
        enableButton.disabled = true;
        enableButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Solicitando...';
        
        // Verificar se j√° temos permiss√£o
        if (Notification.permission === 'granted') {
            console.log('‚úÖ Permiss√£o j√° concedida');
            notificationPermission = 'granted';
            updateNotificationStatus();
            await savePushSubscription();
            showToast('Notifica√ß√µes j√° est√£o ativadas! üéâ', 'success');
            return;
        }
        
        // Verificar se foi bloqueado permanentemente
        if (Notification.permission === 'denied') {
            console.log('‚ùå Permiss√£o negada permanentemente');
            showToast('Notifica√ß√µes foram bloqueadas. V√° em Configura√ß√µes do navegador > Site > Notifica√ß√µes para ativar.', 'warning');
            return;
        }
        
        // Solicitar permiss√£o - com fallback para mobile
        let permission;
        
        try {
            // M√©todo moderno (Promise)
            permission = await Notification.requestPermission();
        } catch (error) {
            console.log('üîß Usando m√©todo callback para compatibilidade...');
            // Fallback para m√©todo callback (alguns browsers mobile)
            permission = await new Promise((resolve) => {
                Notification.requestPermission(resolve);
            });
        }
        
        console.log('üì± Resultado da permiss√£o:', permission);
        notificationPermission = permission;
        updateNotificationStatus();
        
        if (permission === 'granted') {
            console.log('‚úÖ Permiss√£o concedida!');
            // Salvar subscription para push notifications
            await savePushSubscription();
            
            // Mostrar notifica√ß√£o de teste imediata
            try {
                new Notification('üéâ FutAmigo', {
                    body: 'Notifica√ß√µes ativadas com sucesso!',
                    icon: '/static/icons/icon-192x192.png',
                    tag: 'permission-granted',
                    silent: false,
                    requireInteraction: false
                });
            } catch (notifError) {
                console.log('Notifica√ß√£o local falhou:', notifError);
            }
            
            showToast('Notifica√ß√µes ativadas com sucesso! üéâ', 'success');
        } else if (permission === 'denied') {
            console.log('‚ùå Permiss√£o negada pelo usu√°rio');
            showToast('Permiss√£o negada. Para ativar depois: Configura√ß√µes do navegador > Notifica√ß√µes.', 'warning');
        } else {
            console.log('‚è∏Ô∏è Permiss√£o n√£o definida');
            showToast('Permiss√£o n√£o foi definida. Tente novamente.', 'info');
        }
        
    } catch (error) {
        console.error('üí• Erro ao solicitar permiss√£o:', error);
        console.error('üí• Stack trace:', error.stack);
        
        // Mensagens espec√≠ficas de erro para mobile
        let errorMessage = 'Erro ao solicitar permiss√£o para notifica√ß√µes';
        
        if (error.name === 'NotAllowedError') {
            errorMessage = 'Permiss√£o bloqueada pelo navegador. Verifique as configura√ß√µes.';
        } else if (error.name === 'AbortError') {
            errorMessage = 'Solicita√ß√£o cancelada. Tente novamente.';
        } else if (!window.isSecureContext) {
            errorMessage = 'Notifica√ß√µes requerem HTTPS. Acesse via conex√£o segura.';
        }
        
        showToast(`‚ùå ${errorMessage}`, 'danger');
    } finally {
        enableButton.disabled = false;
        enableButton.innerHTML = '<i class="fas fa-bell me-1"></i>Ativar Agora';
    }
}

// Salvar push subscription
async function savePushSubscription() {
    console.log('üíæ Tentando salvar push subscription...');
    
    if (!serviceWorkerRegistration) {
        console.log('‚ö†Ô∏è Service Worker n√£o dispon√≠vel para push subscription');
        return;
    }
    
    try {
        // Verificar se push manager est√° dispon√≠vel
        if (!serviceWorkerRegistration.pushManager) {
            console.log('‚ö†Ô∏è Push Manager n√£o dispon√≠vel');
            return;
        }
        
        // Verificar se j√° existe uma subscription
        let subscription = await serviceWorkerRegistration.pushManager.getSubscription();
        
        if (!subscription) {
            console.log('üìù Criando nova push subscription...');
            
            // Criar nova subscription
            subscription = await serviceWorkerRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: null // Aqui iria a chave VAPID no futuro
            });
        }
        
        console.log('üìù Push subscription obtida:', subscription);
        
        // Salvar no servidor
        const response = await fetch('{% url "save_push_subscription" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                endpoint: subscription.endpoint,
                keys: subscription.toJSON().keys,
                mobile_info: {
                    user_agent: navigator.userAgent,
                    is_mobile: /Mobi|Android/i.test(navigator.userAgent),
                    screen_width: screen.width,
                    screen_height: screen.height
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Push subscription salva com sucesso');
        } else {
            console.error('‚ùå Erro ao salvar push subscription:', result.error);
        }
        
    } catch (error) {
        console.error('üí• Erro ao processar push subscription:', error);
        
        // Log detalhado para debug no mobile
        console.error('üí• Erro detalhado:', {
            name: error.name,
            message: error.message,
            stack: error.stack,
            serviceWorker: !!serviceWorkerRegistration,
            pushManager: !!serviceWorkerRegistration?.pushManager
        });
        
        // N√£o mostrar erro para o usu√°rio pois push subscription √© opcional
        // showToast('Erro ao configurar notifica√ß√µes push', 'warning');
    }
}

// Testar notifica√ß√£o
async function testNotification() {
    try {
        console.log('üß™ Iniciando teste de notifica√ß√£o...');
        console.log('üß™ Permiss√£o atual:', Notification.permission);
        console.log('üß™ URL atual:', window.location.href);
        
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
        
        // Verifica√ß√µes preliminares
        if (Notification.permission !== 'granted') {
            throw new Error('Permiss√£o de notifica√ß√£o n√£o concedida');
        }
        
        if (!window.isSecureContext) {
            throw new Error('Contexto n√£o seguro - HTTPS necess√°rio');
        }
        
        // Teste de notifica√ß√£o local primeiro (mais confi√°vel no mobile)
        console.log('üß™ Testando notifica√ß√£o local...');
        
        try {
            const localNotification = new Notification('üß™ Teste do FutAmigo', {
                body: 'Esta √© uma notifica√ß√£o de teste local. Se voc√™ v√™ isso, est√° funcionando!',
                icon: '/static/icons/icon-192x192.png',
                badge: '/static/icons/icon-72x72.png',
                tag: 'test-local',
                vibrate: [200, 100, 200],
                silent: false,
                requireInteraction: false,
                timestamp: Date.now(),
                data: {
                    url: window.location.origin,
                    test: true
                }
            });
            
            localNotification.onclick = function() {
                console.log('üß™ Notifica√ß√£o local clicada');
                this.close();
            };
            
            localNotification.onshow = function() {
                console.log('‚úÖ Notifica√ß√£o local exibida com sucesso');
            };
            
            localNotification.onerror = function(error) {
                console.error('‚ùå Erro na notifica√ß√£o local:', error);
            };
            
            // Fechar automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                if (localNotification) {
                    localNotification.close();
                }
            }, 5000);
            
        } catch (localError) {
            console.error('‚ùå Erro na notifica√ß√£o local:', localError);
        }
        
        // Agora tenta o teste via servidor
        console.log('üß™ Enviando teste para servidor...');
        
        const response = await fetch('{% url "test_notification" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mobile_test: /Mobi|Android/i.test(navigator.userAgent),
                user_agent: navigator.userAgent,
                timestamp: Date.now()
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üß™ Resposta do servidor:', result);
        
        if (result.success) {
            showToast('‚úÖ Teste de notifica√ß√£o realizado com sucesso! Verifique se recebeu a notifica√ß√£o.', 'success');
        } else {
            throw new Error(result.error || 'Falha no teste do servidor');
        }
        
    } catch (error) {
        console.error('üí• Erro no teste de notifica√ß√£o:', error);
        console.error('üí• Stack:', error.stack);
        
        let errorMessage = `Erro no teste: ${error.message}`;
        
        // Mensagens espec√≠ficas para problemas comuns no mobile
        if (error.message.includes('not supported')) {
            errorMessage = 'Notifica√ß√µes n√£o suportadas neste dispositivo/navegador';
        } else if (error.message.includes('permission')) {
            errorMessage = 'Permiss√£o necess√°ria. Clique em "Ativar Agora" primeiro.';
        } else if (error.message.includes('HTTPS')) {
            errorMessage = 'Acesse o site via HTTPS para notifica√ß√µes funcionarem';
        } else if (error.message.includes('HTTP 403')) {
            errorMessage = 'Erro de permiss√£o no servidor. Fa√ßa login novamente.';
        }
        
        showToast(`‚ùå ${errorMessage}`, 'danger');
        
    } finally {
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Testar Notifica√ß√£o';
    }
}

// Salvar configura√ß√µes
async function saveSettings(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(notificationForm);
        
        const response = await fetch('{% url "notification_settings" %}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Configura√ß√µes salvas com sucesso! ‚úÖ', 'success');
        } else {
            showToast('Erro ao salvar configura√ß√µes', 'danger');
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar configura√ß√µes', 'danger');
    }
}

// Fun√ß√£o para mostrar toasts (reutilizada do palpites.html)
function showToast(message, type = 'info') {
    const toastHTML = `
        <div class="toast align-items-center text-bg-${type} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.body.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remover elemento ap√≥s esconder
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}
{% extends 'bolao/base.html' %}

{% block title %}Jogos Ao Vivo - FutAmigo{% endblock %}

{% block content %}
<!-- Header compacto -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-gradient-danger text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            Brasileir√£o ao Vivo
                        </h4>
                        <small class="opacity-75">Placares e estat√≠sticas em tempo real</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-dark live-indicator pulse">
                            <i class="fas fa-circle text-danger me-1"></i>LIVE
                        </span>
                        <div class="mt-1">
                            <small id="ultima-atualizacao" class="opacity-75">Carregando...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros e Estat√≠sticas -->
<div class="row mb-3">
    <div class="col-md-8">
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary active" data-filtro="todos">
                <i class="fas fa-list me-1"></i>Todos
            </button>
            <button type="button" class="btn btn-outline-success" data-filtro="ao-vivo">
                <i class="fas fa-play me-1"></i>Ao Vivo
            </button>
            <button type="button" class="btn btn-outline-warning" data-filtro="agendados">
                <i class="fas fa-clock me-1"></i>Agendados
            </button>
            <button type="button" class="btn btn-outline-secondary" data-filtro="finalizados">
                <i class="fas fa-check me-1"></i>Finalizados
            </button>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <div class="d-flex align-items-center justify-content-end">
            <div id="stats-quick" class="me-2 small text-muted">
                <!-- Stats ser√£o preenchidas via JS -->
            </div>
            <button id="btn-atualizar" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>
            </button>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading-spinner" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2 text-muted">Buscando jogos...</p>
</div>

<!-- Container dos Jogos -->
<div id="jogos-container" class="d-none">
    <!-- Lista de Jogos -->
    <div id="lista-jogos" class="row">
        <!-- Jogos ser√£o inseridos aqui via JavaScript -->
    </div>

    <!-- Aviso se n√£o houver jogos -->
    <div id="sem-jogos" class="text-center py-4 d-none">
        <i class="fas fa-futbol text-muted" style="font-size: 3rem;"></i>
        <h5 class="text-muted mt-3">Nenhum jogo encontrado</h5>
        <p class="text-muted">N√£o h√° jogos no momento para os filtros selecionados.</p>
    </div>
</div>

<!-- Erro -->
<div id="erro-container" class="text-center py-4 d-none">
    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
    <h5 class="text-warning mt-3">Erro ao carregar jogos</h5>
    <p class="text-muted">Problema ao buscar os placares. Tente novamente.</p>
    <button class="btn btn-warning btn-sm" onclick="carregarJogos()">
        <i class="fas fa-retry me-1"></i>Tentar Novamente
    </button>
</div>

<style>
/* Cores do Brasileir√£o */
:root {
    --brasileirao-verde: #00A859;
    --brasileirao-amarelo: #FFED00;
    --live-red: #dc3545;
}

/* Anima√ß√µes */
.pulse {
    animation: pulse-animation 1.5s infinite;
}

@keyframes pulse-animation {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.live-glow {
    animation: live-glow 2s infinite;
}

@keyframes live-glow {
    0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
    50% { box-shadow: 0 0 20px rgba(220, 53, 69, 0.8); }
    100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
}

/* Card compacto */
.jogo-card {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
    margin-bottom: 0.75rem !important;
}

.jogo-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.jogo-card.ao-vivo {
    border-left: 4px solid var(--live-red);
    background: linear-gradient(135deg, #fff 0%, #fff8f8 100%);
}

.jogo-card.finalizado {
    opacity: 0.85;
    background: #fafafa;
}

.jogo-card.agendado {
    border-left: 4px solid #ffc107;
}

/* Placares */
.placar-compact {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
}

.placar-live {
    color: var(--live-red);
    text-shadow: 0 0 3px rgba(220, 53, 69, 0.3);
}

/* Times */
.escudo-time {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.nome-time {
    font-weight: 600;
    font-size: 0.9rem;
    color: #2c3e50;
}

/* Status */
.status-live {
    background: linear-gradient(45deg, var(--live-red), #e85d75);
    animation: pulse-live 1.5s infinite;
}

@keyframes pulse-live {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Estat√≠sticas compactas */
.stats-compact {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.5rem;
    margin-top: 0.5rem;
}

.stat-item {
    display: inline-block;
    margin-right: 1rem;
    font-size: 0.75rem;
    color: #6c757d;
}

.stat-valor {
    font-weight: 600;
    color: #495057;
}

.progress-custom {
    height: 4px;
    border-radius: 2px;
    background: #e9ecef;
}

/* Responsive */
@media (max-width: 768px) {
    .placar-compact {
        font-size: 1.3rem;
    }
    
    .escudo-time {
        width: 28px;
        height: 28px;
    }
    
    .nome-time {
        font-size: 0.8rem;
    }
    
    .stat-item {
        margin-right: 0.5rem;
        font-size: 0.7rem;
    }
}

/* Gradiente header */
.bg-gradient-danger {
    background: linear-gradient(135deg, var(--live-red) 0%, #c73650 100%);
}
</style>

<script>
let intervalId = null;
let filtroAtual = 'todos';

document.addEventListener('DOMContentLoaded', function() {
    carregarJogos();
    
    // Auto-atualiza√ß√£o a cada 25 segundos
    intervalId = setInterval(carregarJogos, 25000);
    
    // Event listeners
    document.querySelectorAll('[data-filtro]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-filtro]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filtroAtual = this.dataset.filtro;
            aplicarFiltro();
        });
    });
    
    document.getElementById('btn-atualizar').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        carregarJogos().finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync-alt"></i>';
        });
    });
});

window.addEventListener('beforeunload', () => {
    if (intervalId) clearInterval(intervalId);
});

async function carregarJogos() {
    try {
        const response = await fetch('{% url "atualizar_placares_api" %}');
        const data = await response.json();
        
        if (data.success) {
            exibirJogos(data.jogos);
            
            // Stats compactas
            if (data.estatisticas) {
                const stats = data.estatisticas;
                document.getElementById('stats-quick').innerHTML = 
                    `üî¥ ${stats.ao_vivo} | ‚è∞ ${stats.agendados} | ‚úÖ ${stats.finalizados}`;
            }
            
            document.getElementById('ultima-atualizacao').innerHTML = 
                `${data.ultima_atualizacao}${data.debug ? ` ‚Ä¢ ${data.fonte}` : ''}`;
            
            document.getElementById('loading-spinner').classList.add('d-none');
            document.getElementById('erro-container').classList.add('d-none');
            document.getElementById('jogos-container').classList.remove('d-none');
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('loading-spinner').classList.add('d-none');
        document.getElementById('jogos-container').classList.add('d-none');
        document.getElementById('erro-container').classList.remove('d-none');
    }
}

function exibirJogos(jogos) {
    const container = document.getElementById('lista-jogos');
    
    if (!jogos || jogos.length === 0) {
        container.innerHTML = '';
        document.getElementById('sem-jogos').classList.remove('d-none');
        return;
    }
    
    document.getElementById('sem-jogos').classList.add('d-none');
    
    container.innerHTML = jogos.map(jogo => {
        const statusClass = getStatusClass(jogo.status);
        const statusBadge = getStatusBadge(jogo);
        const placarDisplay = getPlacarDisplay(jogo);
        const estatisticasHtml = getEstatisticasCompactas(jogo);
        
        return `
        <div class="col-12">
            <div class="card jogo-card ${statusClass}" data-status="${jogo.status.toLowerCase()}">
                <div class="card-body p-3">
                    <!-- Header com status e competi√ß√£o -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary">${jogo.competicao}</span>
                        ${statusBadge}
                    </div>
                    
                    <!-- Confronto principal -->
                    <div class="row align-items-center">
                        <!-- Time Casa -->
                        <div class="col-5">
                            <div class="d-flex align-items-center">
                                ${jogo.escudo_casa ? 
                                    `<img src="${jogo.escudo_casa}" alt="${jogo.time_casa}" class="escudo-time me-2" onerror="this.style.display='none'">` : 
                                    `<div class="escudo-time bg-light d-flex align-items-center justify-content-center me-2"><i class="fas fa-shield-alt text-muted"></i></div>`
                                }
                                <div class="nome-time text-truncate">${jogo.time_casa}</div>
                            </div>
                        </div>
                        
                        <!-- Placar -->
                        <div class="col-2 text-center">
                            <div class="placar-compact ${jogo.ao_vivo ? 'placar-live' : ''}">
                                ${placarDisplay}
                            </div>
                            ${jogo.minuto ? `<small class="text-${jogo.ao_vivo ? 'danger' : 'muted'}">${jogo.minuto}'</small>` : ''}
                        </div>
                        
                        <!-- Time Visitante -->
                        <div class="col-5">
                            <div class="d-flex align-items-center justify-content-end">
                                <div class="nome-time text-truncate me-2">${jogo.time_visitante}</div>
                                ${jogo.escudo_visitante ? 
                                    `<img src="${jogo.escudo_visitante}" alt="${jogo.time_visitante}" class="escudo-time" onerror="this.style.display='none'">` :
                                    `<div class="escudo-time bg-light d-flex align-items-center justify-content-center"><i class="fas fa-shield-alt text-muted"></i></div>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas em tempo real -->
                    ${estatisticasHtml}
                    
                    <!-- Info adicional -->
                    ${jogo.estadio ? `<small class="text-muted mt-1"><i class="fas fa-map-marker-alt me-1"></i>${jogo.estadio}</small>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
    
    aplicarFiltro();
}

function getStatusClass(status) {
    switch(status.toLowerCase()) {
        case '1h':
        case '2h':
        case 'ht':
        case 'live':
            return 'ao-vivo';
        case 'ft':
        case 'aet':
        case 'pen':
            return 'finalizado';
        default:
            return 'agendado';
    }
}

function getStatusBadge(jogo) {
    if (jogo.ao_vivo) {
        return `<span class="badge status-live text-white">
                    <i class="fas fa-circle me-1"></i>AO VIVO
                </span>`;
    } else if (jogo.finalizado) {
        return `<span class="badge bg-secondary">FINAL</span>`;
    } else {
        return `<span class="badge bg-warning text-dark">
                    ${jogo.horario_formatado || 'AGENDADO'}
                </span>`;
    }
}

function getPlacarDisplay(jogo) {
    if (jogo.gols_casa !== null && jogo.gols_visitante !== null) {
        return `${jogo.gols_casa} - ${jogo.gols_visitante}`;
    }
    return '- : -';
}

function getEstatisticasCompactas(jogo) {
    if (!jogo.estatisticas || !jogo.ao_vivo) return '';
    
    const stats = jogo.estatisticas;
    let html = '<div class="stats-compact mt-2">';
    
    // Posse de bola
    if (stats.casa?.posse_de_bola && stats.visitante?.posse_de_bola) {
        const posseCasa = parseInt(stats.casa.posse_de_bola);
        const posseVisitante = parseInt(stats.visitante.posse_de_bola);
        
        html += `
        <div class="row text-center mb-1">
            <div class="col-4 text-start">
                <span class="stat-valor">${posseCasa}%</span>
            </div>
            <div class="col-4">
                <small class="text-muted">Posse</small>
            </div>
            <div class="col-4 text-end">
                <span class="stat-valor">${posseVisitante}%</span>
            </div>
        </div>
        <div class="progress progress-custom">
            <div class="progress-bar bg-primary" style="width: ${posseCasa}%"></div>
        </div>`;
    }
    
    // Outras stats
    const statsArray = [];
    if (stats.casa?.total_chutes && stats.visitante?.total_chutes) {
        statsArray.push(`<span class="stat-item">‚öΩ <span class="stat-valor">${stats.casa.total_chutes}-${stats.visitante.total_chutes}</span></span>`);
    }
    if (stats.casa?.escanteios && stats.visitante?.escanteios) {
        statsArray.push(`<span class="stat-item">üö© <span class="stat-valor">${stats.casa.escanteios}-${stats.visitante.escanteios}</span></span>`);
    }
    if (stats.casa?.cartoes_amarelos && stats.visitante?.cartoes_amarelos) {
        statsArray.push(`<span class="stat-item">üü® <span class="stat-valor">${stats.casa.cartoes_amarelos}-${stats.visitante.cartoes_amarelos}</span></span>`);
    }
    
    if (statsArray.length > 0) {
        html += `<div class="mt-1">${statsArray.join('')}</div>`;
    }
    
    html += '</div>';
    return html;
}

function aplicarFiltro() {
    const jogos = document.querySelectorAll('[data-status]');
    let visibleCount = 0;
    
    jogos.forEach(jogo => {
        const status = jogo.dataset.status;
        let mostrar = false;
        
        switch(filtroAtual) {
            case 'todos':
                mostrar = true;
                break;
            case 'ao-vivo':
                mostrar = ['1h', '2h', 'ht', 'live'].includes(status);
                break;
            case 'agendados':
                mostrar = ['ns', 'tbd', 'pst'].includes(status);
                break;
            case 'finalizados':
                mostrar = ['ft', 'aet', 'pen'].includes(status);
                break;
        }
        
        jogo.style.display = mostrar ? 'block' : 'none';
        if (mostrar) visibleCount++;
    });
    
    document.getElementById('sem-jogos').classList.toggle('d-none', visibleCount > 0);
}
</script>
{% endblock %}